blueprint:
  name: Motion-Controlled Lighting 5.1.1 â€“ Patched Failsafe Features
  description: 'Motion-controlled lighting with day/night, scenes, lux, sunrise/sunset,
    workday, failsafe (separate day/night), fixed off times (with weekdays), snapshots,
    and logging. Auto-off times run only if no fixed off time is active.

    '
  domain: automation
  input:
    motion_sensors:
      name: Motion Sensor(s)
      description: One or more motion sensors that will control the lighting.
      default: []
      selector:
        entity:
          domain:
          - binary_sensor
          multiple: true
          reorder: false
    optional_switches:
      name: Smart Plugs or Switches
      description: Optional smart plugs or switches that can control the lights/devices.
      default: []
      selector:
        entity:
          domain:
          - switch
          multiple: true
          reorder: false
    main_lights:
      name: Main Lights
      description: Lights that should always turn on when motion is detected (regardless
        of day/night).
      default: []
      selector:
        target:
          entity:
          - domain:
            - light
    auto_off_main:
      name: Main Lights Duration (minutes)
      description: How long the main lights should stay on after the last motion.
      default: []
      selector:
        number:
          min: 0.0
          max: 1200.0
          step: 1.0
          unit_of_measurement: min
          mode: box
    scene_day:
      name: Day Scene
      description: Scene activated during daytime (if selected).
      default: []
      selector:
        entity:
          domain:
          - scene
          multiple: false
          reorder: false
    day_lights:
      name: Daytime Lights
      description: Lights that should only turn on during the day.
      default: []
      selector:
        target:
          entity:
          - domain:
            - light
    auto_off_day:
      name: Day Lights Duration (minutes)
      description: How long the day lights should stay on after the last motion.
      default: []
      selector:
        number:
          min: 0.0
          max: 1200.0
          step: 1.0
          unit_of_measurement: min
          mode: box
    scene_night:
      name: Night Scene
      description: Scene activated during nighttime (if selected).
      default: []
      selector:
        entity:
          domain:
          - scene
          multiple: false
          reorder: false
    night_lights:
      name: Night Lights
      description: Lights that should only turn on during the night.
      default: []
      selector:
        target:
          entity:
          - domain:
            - light
    auto_off_night:
      name: Night Lights Duration (minutes)
      description: How long the night lights should stay on after the last motion.
      default: []
      selector:
        number:
          min: 0.0
          max: 1200.0
          step: 1.0
          unit_of_measurement: min
          mode: box
    lux_sensor:
      name: Lux Sensor
      description: Sensor that measures brightness (lux).
      default: []
      selector:
        entity:
          domain:
          - sensor
          device_class:
          - illuminance
          multiple: false
          reorder: false
    lux_threshold:
      name: Lux Threshold
      description: Lights only turn on if the lux value is below this threshold.
      default: 150
      selector:
        number:
          min: 0.0
          max: 3000.0
          step: 1.0
          unit_of_measurement: lx
          mode: slider
    use_sun_times:
      name: Use Sunrise/Sunset
      description: Whether the automation should use sun times instead of fixed times.
      default: false
      selector:
        boolean: {}
    sunset_offset:
      name: Sunset Offset
      description: Adjustment for sunset time, earlier or later.
      default: 00:00:00
      selector:
        time: {}
    sunrise_offset:
      name: Sunrise Offset
      description: Adjustment for sunrise time, earlier or later.
      default: 00:00:00
      selector:
        time: {}
    fixed_off_time_1:
      name: Fixed Off Time 1 (optional)
      description: Time when lights or smart plugs automatically turn off.
      default: []
      selector:
        time: {}
    fixed_off_weekdays_1:
      name: Active Weekdays (Fixed Time 1)
      description: Which weekdays fixed off time 1 should apply to.
      default: []
      selector:
        select:
          multiple: true
          options:
          - label: Monday
            value: mon
          - label: Tuesday
            value: tue
          - label: Wednesday
            value: wed
          - label: Thursday
            value: thu
          - label: Friday
            value: fri
          - label: Saturday
            value: sat
          - label: Sunday
            value: sun
          custom_value: false
          sort: false
    fixed_off_time_2:
      name: Fixed Off Time 2 (optional)
      description: Time when lights or smart plugs automatically turn off.
      default: []
      selector:
        time: {}
    fixed_off_weekdays_2:
      name: Active Weekdays (Fixed Time 2)
      description: Which weekdays fixed off time 2 should apply to.
      default: []
      selector:
        select:
          multiple: true
          options:
          - label: Monday
            value: mon
          - label: Tuesday
            value: tue
          - label: Wednesday
            value: wed
          - label: Thursday
            value: thu
          - label: Friday
            value: fri
          - label: Saturday
            value: sat
          - label: Sunday
            value: sun
          custom_value: false
          sort: false
    day_start:
      name: Day Start
      description: Time when the day mode activates.
      default: 07:00:00
      selector:
        time: {}
    day_end:
      name: Day End
      description: 'Time when the day mode deactivates. Day End cannot be the same
        as Night Start. Example: 22:00:00'
      default: '22:00:00'
      selector:
        time: {}
    active_weekdays_day:
      name: Active Weekdays (Day)
      description: Select which days the day mode should be active.
      default: []
      selector:
        select:
          multiple: true
          options:
          - label: Monday
            value: mon
          - label: Tuesday
            value: tue
          - label: Wednesday
            value: wed
          - label: Thursday
            value: thu
          - label: Friday
            value: fri
          - label: Saturday
            value: sat
          - label: Sunday
            value: sun
          custom_value: false
          sort: false
    night_start:
      name: Night Start
      description: 'Time when night mode activates. Night Start cannot be the same
        as Day End. Example: 22:00:01'
      default: '22:00:01'
      selector:
        time: {}
    night_end:
      name: Night End
      description: Time when night mode deactivates.
      default: 06:59:59
      selector:
        time: {}
    active_weekdays_night:
      name: Active Weekdays (Night)
      description: Select which days the night mode should be active.
      default: []
      selector:
        select:
          multiple: true
          options:
          - label: Monday
            value: mon
          - label: Tuesday
            value: tue
          - label: Wednesday
            value: wed
          - label: Thursday
            value: thu
          - label: Friday
            value: fri
          - label: Saturday
            value: sat
          - label: Sunday
            value: sun
          custom_value: false
          sort: false
    workday_sensor:
      name: Workday Sensor
      description: Sensor that indicates workdays.
      default: []
      selector:
        entity:
          domain:
          - binary_sensor
          multiple: false
          reorder: false
    enable_failsafe:
      name: Enable Failsafe
      description: Activates the failsafe feature that automatically turns off lights
        if auto-off did not trigger correctly.
      default: true
      selector:
        boolean: {}
    failsafe_timer_main:
      name: Failsafe Timer Main Lights (minutes)
      description: Number of minutes before main lights automatically turn off if
        auto-off did not trigger as expected.
      default: []
      selector:
        number:
          min: 1.0
          max: 240.0
          step: 1.0
          unit_of_measurement: min
          mode: slider
    failsafe_timer_day:
      name: Failsafe Timer Day Lights (minutes)
      description: Number of minutes before day lights automatically turn off if auto-off
        did not trigger as expected.
      default: []
      selector:
        number:
          min: 1.0
          max: 120.0
          step: 1.0
          unit_of_measurement: min
          mode: slider
    failsafe_timer_night:
      name: Failsafe Timer Night Lights (minutes)
      description: Number of minutes before night lights automatically turn off if
        auto-off did not trigger as expected.
      default: []
      selector:
        number:
          min: 1.0
          max: 120.0
          step: 1.0
          unit_of_measurement: min
          mode: slider
    input_text_last_scene:
      name: Input Text - Last Scene
      description: Input Text entity that stores the name of the last active scene.
      default: []
      selector:
        entity:
          domain:
          - input_text
          multiple: false
          reorder: false
  source_url: https://raw.githubusercontent.com/razzietheman/Advanced-Motion-Activated-Light-Blueprint/main/Smarter_Lighting.yaml
trigger:
- platform: state
  entity_id: !input motion_sensors
  to: 'on'
  id: motion_on
- platform: state
  entity_id: !input motion_sensors
  from: 'off'
  to: 'on'
  id: motion_on
- platform: state
  entity_id: !input motion_sensors
  from: 'on'
  to: 'off'
  id: motion_off
- platform: state
  entity_id: !input optional_switches
  to: 'on'
  id: switch_on
- platform: state
  entity_id: !input optional_switches
  to: 'off'
  id: switch_off
- platform: sun
  event: sunrise
  offset: !input sunrise_offset
  id: sunrise_trigger
- platform: sun
  event: sunset
  offset: !input sunset_offset
  id: sunset_trigger
- platform: time
  at: !input fixed_off_time_1
  id: fixed_off_1
- platform: time
  at: !input fixed_off_time_2
  id: fixed_off_2
mode: restart
variables:
  main_lights_var: !input main_lights
  day_lights_var: !input day_lights
  night_lights_var: !input night_lights
  scene_day_var: !input scene_day
  scene_night_var: !input scene_night
  last_scene_entity: !input input_text_last_scene
  lux_sensor_var: !input lux_sensor
  lux_threshold_var: !input lux_threshold
  use_sun_times_var: !input use_sun_times
  workday_sensor_var: !input workday_sensor
  auto_off_main_var: !input auto_off_main
  auto_off_day_var: !input auto_off_day
  auto_off_night_var: !input auto_off_night
  fixed_off_weekdays_1_var: !input fixed_off_weekdays_1
  fixed_off_weekdays_2_var: !input fixed_off_weekdays_2
  day_start_var: !input day_start
  day_end_var: !input day_end
  night_start_var: !input night_start
  night_end_var: !input night_end
  active_weekdays_day_var: !input active_weekdays_day
  active_weekdays_night_var: !input active_weekdays_night
  enable_failsafe_var: !input enable_failsafe
  failsafe_timer_main_var: !input failsafe_timer_main
  failsafe_timer_day_var: !input failsafe_timer_day
  failsafe_timer_night_var: !input failsafe_timer_night
action:
- choose:
  - conditions:
    - condition: or
      conditions:
      - condition: trigger
        id: motion_on
      - condition: trigger
        id: switch_on
    - condition: template
      value_template: '{{ (optional_switches | default([])) != [] or trigger.id ==
        ''motion_on'' }}'
    sequence:
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ main_lights_var | default('''') != '''' }}'
        sequence:
        - service: scene.create
          data:
            scene_id: snapshot_before_on
            snapshot_entities: "{% if main_lights_var is string %}\n  {{ main_lights_var
              }}\n{% elif main_lights_var is mapping %}\n  {{ main_lights_var.entity_id
              }}\n{% elif main_lights_var is iterable %}\n  {{ main_lights_var | join(',')
              }}\n{% endif %}\n"
    - choose:
      - conditions:
        - condition: template
          value_template: "{% set t = now().time() %} {% set start = strptime(day_start_var,
            '%H:%M:%S').time() %} {% set end = strptime(day_end_var, '%H:%M:%S').time()
            %} {% if start <= end %}\n  {{ t >= start and t <= end }}\n{% else %}\n
            \ {{ t >= start or t <= end }}\n{% endif %}\n"
        sequence:
        - choose:
          - conditions:
            - condition: template
              value_template: '{{ scene_day_var | default('''') != '''' }}'
            sequence:
            - service: scene.turn_on
              target:
                entity_id: '{{ scene_day_var }}'
          - conditions:
            - condition: template
              value_template: '{{ day_lights_var | default('''') != '''' and (lux_sensor_var
                | default('''') == '''' or states(lux_sensor_var) | float < lux_threshold_var
                | float) }}'
            sequence:
            - service: light.turn_on
              target:
                entity_id: "{% if day_lights_var is string %}\n  {{ day_lights_var
                  }}\n{% elif day_lights_var is mapping %}\n  {{ day_lights_var.entity_id
                  }}\n{% elif day_lights_var is iterable %}\n  {{ day_lights_var |
                  join(',') }}\n{% endif %}\n"
          - conditions:
            - condition: template
              value_template: '{{ main_lights_var | default('''') != '''' and (lux_sensor_var
                | default('''') == '''' or states(lux_sensor_var) | float < lux_threshold_var
                | float) }}'
            sequence:
            - service: light.turn_on
              target:
                entity_id: "{% if main_lights_var is string %}\n  {{ main_lights_var
                  }}\n{% elif main_lights_var is mapping %}\n  {{ main_lights_var.entity_id
                  }}\n{% elif main_lights_var is iterable %}\n  {{ main_lights_var
                  | join(',') }}\n{% endif %}\n"
    - choose:
      - conditions:
        - condition: template
          value_template: "{% set t = now().time() %} {% set start = strptime(night_start_var,
            '%H:%M:%S').time() %} {% set end = strptime(night_end_var, '%H:%M:%S').time()
            %} {% if start <= end %}\n  {{ t >= start and t <= end }}\n{% else %}\n
            \ {{ t >= start or t <= end }}\n{% endif %}\n"
        sequence:
        - choose:
          - conditions:
            - condition: template
              value_template: '{{ scene_night_var | default('''') != '''' }}'
            sequence:
            - service: scene.turn_on
              target:
                entity_id: '{{ scene_night_var }}'
          - conditions:
            - condition: template
              value_template: '{{ night_lights_var | default('''') != '''' and (lux_sensor_var
                | default('''') == '''' or states(lux_sensor_var) | float < lux_threshold_var
                | float) }}'
            sequence:
            - service: light.turn_on
              target:
                entity_id: "{% if night_lights_var is string %}\n  {{ night_lights_var
                  }}\n{% elif night_lights_var is mapping %}\n  {{ night_lights_var.entity_id
                  }}\n{% elif night_lights_var is iterable %}\n  {{ night_lights_var
                  | join(',') }}\n{% endif %}\n"
          - conditions:
            - condition: template
              value_template: '{{ main_lights_var | default('''') != '''' and (lux_sensor_var
                | default('''') == '''' or states(lux_sensor_var) | float < lux_threshold_var
                | float) }}'
            sequence:
            - service: light.turn_on
              target:
                entity_id: "{% if main_lights_var is string %}\n  {{ main_lights_var
                  }}\n{% elif main_lights_var is mapping %}\n  {{ main_lights_var.entity_id
                  }}\n{% elif main_lights_var is iterable %}\n  {{ main_lights_var
                  | join(',') }}\n{% endif %}\n"
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ last_scene_entity | default('''') != '''' }}'
        sequence:
        - service: input_text.set_value
          data:
            entity_id: '{{ last_scene_entity }}'
            value: Day/Night ON
    - service: logbook.log
      data:
        name: Motion Control
        message: Day/Night ON activated via motion or switch.
- choose:
  - conditions:
    - condition: or
      conditions:
      - condition: trigger
        id: motion_off
      - condition: trigger
        id: switch_off
    - condition: template
      value_template: '{{ main_lights_var | default('''') != '''' }}'
    sequence:
    - delay:
        minutes: '{{ auto_off_main_var }}'
    - choose:
      - conditions:
        - condition: template
          value_template: '{{ main_lights_var | default('''') != '''' }}'
        sequence:
        - service: light.turn_off
          target:
            entity_id: "{% if main_lights_var is string %}\n  {{ main_lights_var }}\n{%
              elif main_lights_var is mapping %}\n  {{ main_lights_var.entity_id }}\n{%
              elif main_lights_var is iterable %}\n  {{ main_lights_var | join(',')
              }}\n{% endif %}\n"
- choose:
  - conditions:
    - condition: template
      value_template: '{{ day_lights_var | default('''') != '''' }}'
    sequence:
    - delay:
        minutes: '{{ auto_off_day_var }}'
    - service: light.turn_off
      target:
        entity_id: "{% if day_lights_var is string %}\n  {{ day_lights_var }}\n{%
          elif day_lights_var is mapping %}\n  {{ day_lights_var.entity_id }}\n{%
          elif day_lights_var is iterable %}\n  {{ day_lights_var | join(',') }}\n{%
          endif %}\n"
    - service: logbook.log
      data:
        name: Motion Control
        message: 'Auto-off Day: Day lights turned off.'
- choose:
  - conditions:
    - condition: template
      value_template: '{{ night_lights_var | default('''') != '''' }}'
    sequence:
    - delay:
        minutes: '{{ auto_off_night_var }}'
    - service: light.turn_off
      target:
        entity_id: "{% if night_lights_var is string %}\n  {{ night_lights_var }}\n{%
          elif night_lights_var is mapping %}\n  {{ night_lights_var.entity_id }}\n{%
          elif night_lights_var is iterable %}\n  {{ night_lights_var | join(',')
          }}\n{% endif %}\n"
    - service: logbook.log
      data:
        name: Motion Control
        message: 'Auto-off Night: Night lights turned off.'
- choose:
  - conditions:
    - condition: trigger
      id: fixed_off_1
    - condition: template
      value_template: '{{ now().strftime(''%a'').lower() in fixed_off_weekdays_1_var
        }}'
    sequence:
    - service: light.turn_off
      target:
        entity_id: "{% set lights = [] %} {% for var in [main_lights_var, day_lights_var,
          night_lights_var] %}\n  {% if var | default('') != '' %}\n    {% if var
          is string %}\n      {% set _ = lights.append(var) %}\n    {% elif var is
          mapping %}\n      {% set _ = lights.append(var.entity_id) %}\n    {% elif
          var is iterable %}\n      {% set _ = lights.extend(var) %}\n    {% endif
          %}\n  {% endif %}\n{% endfor %} {{ lights | join(',') }}\n"
- choose:
  - conditions:
    - condition: trigger
      id: fixed_off_2
    - condition: template
      value_template: '{{ now().strftime(''%a'').lower() in fixed_off_weekdays_2_var
        }}'
    sequence:
    - service: light.turn_off
      target:
        entity_id: "{% set lights = [] %} {% for var in [main_lights_var, day_lights_var,
          night_lights_var] %}\n  {% if var | default('') != '' %}\n    {% if var
          is string %}\n      {% set _ = lights.append(var) %}\n    {% elif var is
          mapping %}\n      {% set _ = lights.append(var.entity_id) %}\n    {% elif
          var is iterable %}\n      {% set _ = lights.extend(var) %}\n    {% endif
          %}\n  {% endif %}\n{% endfor %} {{ lights | join(',') }}\n"
- choose:
  - conditions:
    - condition: template
      value_template: '{{ enable_failsafe_var }}'
    - condition: template
      value_template: "{% set lights = [] %} {% if main_lights_var is string %}\n
        \ {% set lights = [main_lights_var] %}\n{% elif main_lights_var is mapping
        %}\n  {% set lights = [main_lights_var.entity_id] %}\n{% elif main_lights_var
        is iterable %}\n  {% set lights = main_lights_var %}\n{% endif %} {{ lights
        | select('is_state','on') | list | count > 0 }}\n"
    sequence:
    - delay:
        minutes: '{{ failsafe_timer_main_var }}'
    - service: light.turn_off
      target:
        entity_id: "{% set lights = [] %} {% if main_lights_var is string %}\n  {%
          set lights = [main_lights_var] %}\n{% elif main_lights_var is mapping %}\n
          \ {% set lights = [main_lights_var.entity_id] %}\n{% elif main_lights_var
          is iterable %}\n  {% set lights = main_lights_var %}\n{% endif %} {{ lights
          | join(',') }}\n"
    - service: logbook.log
      data:
        name: Motion Control
        message: 'Failsafe Main: Lights turned off automatically.'
- choose:
  - conditions:
    - condition: template
      value_template: '{{ enable_failsafe_var and day_lights_var | default('''') !=
        '''' }}'
    sequence:
    - delay:
        minutes: '{{ failsafe_timer_day_var }}'
    - service: light.turn_off
      target:
        entity_id: "{% if day_lights_var is string %}\n  {{ day_lights_var }}\n{%
          elif day_lights_var is mapping %}\n  {{ day_lights_var.entity_id }}\n{%
          elif day_lights_var is iterable %}\n  {{ day_lights_var | join(',') }}\n{%
          endif %}\n"
    - service: logbook.log
      data:
        name: Motion Control
        message: 'Failsafe Day: Day lights turned off automatically.'
- choose:
  - conditions:
    - condition: template
      value_template: '{{ enable_failsafe_var and night_lights_var | default('''')
        != '''' }}'
    sequence:
    - delay:
        minutes: '{{ failsafe_timer_night_var }}'
    - service: light.turn_off
      target:
        entity_id: "{% if night_lights_var is string %}\n  {{ night_lights_var }}\n{%
          elif night_lights_var is mapping %}\n  {{ night_lights_var.entity_id }}\n{%
          elif night_lights_var is iterable %}\n  {{ night_lights_var | join(',')
          }}\n{% endif %}\n"
    - service: logbook.log
      data:
        name: Motion Control
        message: 'Failsafe Night: Night lights turned off automatically.'
